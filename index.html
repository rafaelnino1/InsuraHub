<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>InsuraHub App</title>

  <!-- PWA meta -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#3498db">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Iconos / fuentes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#3498db;--primary-light:#5dade2;--primary-dark:#2c80b9;
      --background:#eef4ff;--card-bg:#fff;--text-dark:#1f2d3d;--text-light:#7f8c8d;
      --success:#2ecc71;--warning:#f39c12;--danger:#e74c3c;
      --depth-1:0 6px 14px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.06);
      --depth-2:0 12px 28px rgba(0,0,0,.12),0 4px 10px rgba(0,0,0,.08);
      --depth-3:0 22px 50px rgba(0,0,0,.18),0 8px 16px rgba(0,0,0,.12);
      --ring-bg:#edf2f7
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,Segoe UI,Tahoma,Verdana,sans-serif}
    body{
      min-height:100vh;color:var(--text-dark);line-height:1.6;padding:20px;
      background:
        radial-gradient(1000px 500px at 10% 0%,rgba(93,173,226,.25),transparent 60%),
        radial-gradient(900px 500px at 100% 30%,rgba(46,204,113,.18),transparent 60%),
        linear-gradient(135deg,#e6f0ff 0%,#d6ecff 40%,#cfeef0 100%);
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto auto 1fr;
      gap:16px;
    }

    /* ===== Global header y stats abarcan TODA la página ===== */
    header.global-header{
      grid-column:1 / -1;
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      padding:22px 30px;border-radius:18px;box-shadow:var(--depth-3);
      display:flex;justify-content:space-between;align-items:center;color:#fff;position:relative;overflow:hidden
    }
    header.global-header::before{content:"";position:absolute;inset:-30% -20% auto auto;width:120%;height:220%;background:radial-gradient(closest-side,rgba(255,255,255,.18),transparent 60%);transform:rotate(25deg)}
    .app-title{display:flex;align-items:center;gap:16px;position:relative;z-index:1}
    .app-icon{width:72px;height:72px;border-radius:16px;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:28px;backdrop-filter:blur(10px);box-shadow:var(--depth-2), inset 0 1px 0 rgba(255,255,255,.35);border:1px solid rgba(255,255,255,.35);overflow:hidden}
    .app-icon img{width:72px;height:72px;object-fit:contain;display:block}
    .app-title-text h1{font-size:26px;font-weight:800;margin-bottom:4px}
    .user-actions{display:flex;gap:10px;z-index:1}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 18px;background:#fff;color:var(--primary);border:none;border-radius:12px;cursor:pointer;font-weight:700;transition:transform .2s,box-shadow .2s;text-decoration:none;box-shadow:var(--depth-1);min-height:40px}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--depth-2)}
    .btn-outline{background:transparent;border:2px solid #fff;color:#fff;box-shadow:none}
    .btn-outline:hover{background:#fff;color:var(--primary)}

    .stats-bar{
      grid-column:1 / -1;
      display:flex;justify-content:space-around;background:var(--card-bg);border-radius:16px;padding:14px 16px;box-shadow:var(--depth-2);
      background:linear-gradient(180deg,#fff 0%,#f3f8ff 100%),radial-gradient(120% 80% at 20% 0%,rgba(93,173,226,.1),transparent 60%);
      border:1px solid rgba(52,152,219,.12)
    }
    .stat-item{text-align:center;padding:0 12px;position:relative}
    .stat-item:not(:last-child)::after{content:"";position:absolute;right:0;top:18%;height:64%;width:1px;background:linear-gradient(to bottom,transparent,rgba(52,152,219,.35),transparent)}
    .stat-value{font-size:28px;font-weight:900;margin-bottom:2px;background:linear-gradient(180deg,#2c80b9,#3498db);-webkit-background-clip:text;background-clip:text;color:transparent}
    .stat-label{color:var(--text-light);font-size:12px;font-weight:700;letter-spacing:.3px}

    /* ===== Sidebar ===== */
    .hamburger{
      display:none; position:fixed; left:12px; top:12px; z-index:10001;
      width:44px; height:44px; border-radius:12px; border:none; background:#fff; box-shadow:var(--depth-2); color:#2c80b9; font-size:20px;
    }
    .sidebar{
      grid-column:1; grid-row:3;
      width:280px; flex:0 0 280px;
      background:linear-gradient(180deg,#e8fff2 0%, #c9f7df 45%, #a6edc7 100%);
      border:1px solid rgba(32,140,90,.20);
      border-radius:16px; box-shadow:var(--depth-2);
      padding:14px; position:sticky; top:16px; height:calc(100dvh - 32px); overflow:auto;
    }
    .side-title{font-weight:900;color:#0e7d4c;display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .side-btn{
      width:100%; display:flex; align-items:center; gap:10px; padding:12px; border-radius:12px;
      border:1px solid rgba(52,152,219,.25);
      background:linear-gradient(180deg,#6fb6e9 0%, #3a97dc 50%, #2c80b9 100%);
      color:#fff;
      box-shadow:0 8px 18px rgba(41,128,185,.25), inset 0 1px 0 rgba(255,255,255,.25);
      cursor:pointer; font-weight:800; margin-bottom:10px; transition:transform .2s, box-shadow .2s, filter .2s;
    }
    .side-btn:hover{transform:translateY(-2px); box-shadow:var(--depth-2); filter:saturate(1.05)}
    .side-badge{
      margin-left:auto; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.4); background:rgba(255,255,255,.2);
      color:#fff
    }
    .ok{background:linear-gradient(180deg,#c8ffd6,#a9f7bf); color:#0d6b3a; border-color:rgba(46,204,113,.35)}
    .bad{background:linear-gradient(180deg,#ffd6d6,#ffc5c5); color:#8b1e1e; border-color:rgba(231,76,60,.35)}

    /* Sidebar móvil */
    @media(max-width:1100px){
      body{padding-top:72px}
      .hamburger{display:block}
      .sidebar{position:fixed; left:12px; top:64px; height:calc(100dvh - 76px); z-index:10000; transition:transform .25s ease}
      .sidebar.hidden{transform:translateX(-110%);}
    }

    /* ===== Contenido principal ===== */
    .container{
      grid-column:2; grid-row:3;
      max-width:1300px; margin:0 auto; width:100%;
      display:flex; flex-direction:column;
    }

    /* Cards pólizas activas */
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:26px}
    .card{
      background:var(--card-bg);border-radius:14px;padding:14px;box-shadow:var(--depth-2);
      transition:transform .2s,box-shadow .2s;display:flex;flex-direction:column;position:relative;overflow:hidden;
      border:1px solid rgba(52,152,219,.1);
      background-image:radial-gradient(800px 240px at -10% 0%,rgba(93,173,226,.12),transparent 40%),linear-gradient(180deg,#fff 0%,#f7f9ff 100%)
    }
    .card:hover{transform:translateY(-2px);box-shadow:var(--depth-3)}
    .card.status-good::after,.card.status-warning::after,.card.status-danger::after{content:"";position:absolute;left:0;top:0;bottom:0;width:5px}
    .card.status-good::after{background:linear-gradient(180deg,#41d98b,#2cb56f)}
    .card.status-warning::after{background:linear-gradient(180deg,#f7c052,#e99a10)}
    .card.status-danger::after{background:linear-gradient(180deg,#f07b72,#e0443a)}

    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid rgba(52,152,219,.12)}
    .insurer-logo-header{width:48px;height:48px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;border:1px solid rgba(52,152,219,.18);box-shadow:var(--depth-1);overflow:hidden;flex:0 0 48px}
    .insurer-logo-header img{width:100%;height:100%;object-fit:contain}
    .logo-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#95a5a6;background:#ecf0f1;border-radius:inherit}
    .header-right{display:flex;align-items:center;gap:10px}
    .insurance-type{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:linear-gradient(180deg,rgba(52,152,219,.14),rgba(52,152,219,.06));border:1px solid rgba(52,152,219,.18);font-weight:800;font-size:14px;color:var(--primary-dark)}
    .insurance-icon{width:40px;height:40px;background:linear-gradient(180deg,var(--primary-light),var(--primary));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 6px 12px rgba(52,152,219,.3);border:1px solid rgba(255,255,255,.4)}
    .insurance-icon i{font-size:16px}

    .card-details{flex-grow:1}
    .detail-item{display:flex;justify-content:space-between;margin:8px 0}
    .detail-label{color:var(--text-light);font-size:13px}
    .detail-value{font-weight:700;color:var(--text-dark);font-size:14px}

    .contact-line{display:flex;align-items:center;justify-content:center;gap:6px;font-weight:700;color:#105b96;background:linear-gradient(180deg,#f7fbff,#eef6ff);border:1px solid rgba(52,152,219,.18);padding:6px 8px;border-radius:10px;margin:6px 0;box-shadow:var(--depth-1);line-height:1.2;font-size:12px}
    .contact-line i{font-size:12px;color:#2c80b9}
    .contact-line span:last-child{font-size:12px;font-weight:800}

    .ring-row{display:flex;align-items:center;gap:12px;margin-top:6px}
    .status-container{display:flex;flex-direction:column;align-items:center}
    .status-ring{position:relative;width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;background:conic-gradient(var(--ring-color,var(--success)) 0 var(--progress,100%),var(--ring-bg) var(--progress,100%) 100%);box-shadow:0 12px 22px rgba(0,0,0,.18),0 6px 10px rgba(0,0,0,.1)}
    .status-ring::before{content:"";position:absolute;inset:-2px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.85),rgba(255,255,255,.25) 40%,rgba(255,255,255,0) 60%),conic-gradient(from -90deg,rgba(255,255,255,.25),rgba(0,0,0,.08),rgba(255,255,255,.25))}
    .status-ring::after{content:"";position:absolute;inset:7px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#fff,#f5f8ff 60%,#e9eef7)}
    .status-ring-inner{position:relative;z-index:2;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#2c3e50;text-shadow:0 1px 0 rgba(255,255,255,.7)}
    .days-text{font-size:11px;text-align:center;margin-top:6px;color:var(--text-light);font-weight:700}
    .status-ring-good{--ring-color:var(--success)}.status-ring-warning{--ring-color:var(--warning)}.status-ring-danger{--ring-color:var(--danger)}
    .ring-actions{display:flex;flex-direction:column;gap:8px;min-width:160px}
    .ring-actions .btn{width:100%;min-height:38px;padding:8px 12px}
    .btn-success{background:linear-gradient(180deg,#35d07f,#2cb56f);color:#fff}
    .btn-warning{background:linear-gradient(180deg,#f6b449,#e99a10);color:#fff}
    .btn-danger{background:linear-gradient(180deg,#ef6b61,#e0443a);color:#fff}
    .btn-soft{background:linear-gradient(180deg,#f7fbff,#eef6ff);color:#2c3e50;border:1px solid rgba(52,152,219,.2)}

    /* Footer */
    footer{
      grid-column:2; grid-row:3;
      text-align:center;margin-top:16px;padding:10px 14px;color:#fff;
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      border-radius:12px;box-shadow:0 8px 18px rgba(52,152,219,.25)
    }
    footer p{font-size:12px;font-weight:600}

    /* Modales base */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;justify-content:center;align-items:center;backdrop-filter:blur(6px)}
    .modal-content{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.98));border-radius:18px;width:96%;max-width:1400px;padding:28px;box-shadow:var(--depth-3);max-height:90vh;overflow:auto;position:relative;border:1px solid rgba(52,152,219,.15)}
    .modal-header{text-align:center;margin-bottom:14px;position:relative}
    .close-modal{position:absolute;top:-10px;right:-10px;width:34px;height:34px;background:var(--danger);color:#fff;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}

    .section-card{background:linear-gradient(180deg,#ffffff,#f6f8ff);border:1px solid rgba(52,152,219,.15);border-radius:16px;padding:16px;box-shadow:var(--depth-1);margin-bottom:14px}
    .section-title{font-weight:900;color:#155a8f;margin-bottom:8px;display:flex;align-items:center;gap:8px}

    /* ====== Vault de documentos ====== */
    .vault{
      display:grid;grid-template-columns:minmax(260px,320px) 1fr;gap:16px;
    }
    .vault-list{
      border:1px solid rgba(52,152,219,.18);border-radius:12px;background:#fff;box-shadow:var(--depth-1);overflow:auto;
      max-height:60vh;
    }
    .vault-item{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #f0f3f7;cursor:pointer
    }
    .vault-item:hover{background:#f7fbff}
    .vault-item .file-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(52,152,219,.18);background:#fff}
    .vault-item .meta{display:flex;flex-direction:column}
    .vault-item .name{font-weight:800}
    .vault-item .sub{font-size:12px;color:#567}

    .vault-preview{
      border:1px solid rgba(52,152,219,.18);border-radius:12px;background:#fff;box-shadow:var(--depth-1);
      min-height:300px;display:flex;align-items:center;justify-content:center;overflow:hidden
    }
    .vault-empty{padding:18px;text-align:center;color:#567;font-weight:700}

    /* Móvil */
    @media(max-width:900px){
      .vault{grid-template-columns:1fr}
      footer{grid-column:1 / -1}
      .container{grid-column:1 / -1}
      .sidebar{position:fixed; left:12px; top:64px;}
    }

    /* Móvil detalles */
    @media(max-width:768px){
      .stats-bar{flex-direction:column;gap:14px}
      .stat-item:not(:last-child)::after{display:none}
      header.global-header{flex-direction:column;gap:12px;text-align:center}
      .user-actions{justify-content:center}
      .ring-row{align-items:stretch}
    }
  </style>
</head>
<body>
  <!-- Toggle sidebar (móvil) -->
  <button class="hamburger" id="toggleSidebar" aria-label="Menú"><i class="fas fa-bars"></i></button>

  <!-- ===== Header global que cruza toda la página ===== -->
  <header class="global-header">
    <div class="app-title">
      <div class="app-icon"><img src="logos/insurahublogo.png" alt="InsuraHub" onerror="this.remove();this.parentNode.textContent='IH'"></div>
      <div class="app-title-text"><h1>InsuraHub</h1><p>Gestión Inteligente de Seguros</p></div>
    </div>
    <div class="user-actions">
      <!-- Eliminado botón Nueva Póliza -->
      <button class="btn btn-outline" id="loginBtn"><i class="fas fa-user"></i> Iniciar Sesión</button>
    </div>
  </header>

  <!-- ===== Stats globales que cruzan toda la página ===== -->
  <div class="stats-bar" id="globalStats">
    <div class="stat-item"><div class="stat-value" id="totalPolicies">6</div><div class="stat-label">Pólizas Activas</div></div>
    <div class="stat-item"><div class="stat-value" id="expiringPolicies">2</div><div class="stat-label">Por Vencer (&lt;30 días)</div></div>
    <div class="stat-item"><div class="stat-value" id="totalCoverage">$985.000.000</div><div class="stat-label">Cobertura Total</div></div>
  </div>

  <!-- ===== Sidebar (sin logo) ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="side-title"><i class="fas fa-layer-group"></i> Ecosistema InsuraHub</div>

    <button class="side-btn" id="openSARLAFT">
      <i class="fas fa-clipboard-check"></i> Tu formulario SARLAFT al día
      <span class="side-badge bad" id="sarlaftBadge">Pendiente</span>
    </button>

    <button class="side-btn" id="openUploader">
      <i class="fas fa-bolt"></i> Cargar pólizas automáticamente
      <span class="side-badge">Subir</span>
    </button>

    <button class="side-btn" id="openPoliciesVault">
      <i class="fas fa-folder-open"></i> Tus pólizas
    </button>

    <button class="side-btn" id="openDataUpdate">
      <i class="fas fa-rotate"></i> Actualización de datos
    </button>
  </aside>

  <!-- ===== Contenido principal: Cards de pólizas activas ===== -->
  <div class="container">
    <div class="card-grid" id="policyGrid"></div>
    <footer>
      <p>© 2025 InsuraHub - Todos tus seguros en un solo lugar</p>
    </footer>
  </div>

  <!-- ===== Modales ===== -->

  <!-- Login -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Iniciar Sesión</h2>
        <p>Accede a tu cuenta para gestionar tus seguros</p>
        <button class="close-modal" id="closeLoginModal">×</button>
      </div>
      <div class="social-login" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <button type="button" class="btn" id="loginGoogle"><i class="fab fa-google"></i> Google</button>
        <button type="button" class="btn" id="loginFacebook"><i class="fab fa-facebook-f"></i> Facebook</button>
        <button type="button" class="btn" id="loginApple"><i class="fab fa-apple"></i> Apple</button>
      </div>
      <div style="text-align:center;color:#99a3ad;font-weight:700;margin:8px 0 14px">o con tu correo</div>
      <form>
        <div class="form-group"><label class="form-label" for="email"><i class="fas fa-envelope"></i> Correo Electrónico</label><div class="input-wrap"><input type="email" id="email" required placeholder="tucorreo@dominio.com"></div></div>
        <div class="form-group"><label class="form-label" for="password"><i class="fas fa-lock"></i> Contraseña</label><div class="input-wrap"><input type="password" id="password" required placeholder="••••••••"></div></div>
        <button type="submit" class="btn" style="width:100%"><i class="fas fa-right-to-bracket"></i> Iniciar Sesión</button>
      </form>
    </div>
  </div>

  <!-- Uploader de documentos (PDF/imagen/doc) -->
  <div class="modal" id="uploaderModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Cargar pólizas (archivos)</h2>
        <p style="color:#567;font-weight:600">Sube tus pólizas en PDF, imágenes o documentos. Se guardarán en “Tus pólizas”.</p>
        <button class="close-modal" id="closeUploader">×</button>
      </div>

      <div class="section-card">
        <div class="section-title"><i class="fas fa-upload"></i> Subir archivos</div>
        <div id="fileDrop" style="padding:18px;border:2px dashed rgba(52,152,219,.35);border-radius:12px;text-align:center;background:#f8fbff;cursor:pointer">
          Arrastra y suelta aquí o haz clic para seleccionar
          <input type="file" id="fileInput" accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" multiple style="display:none">
        </div>
        <div id="uploadHint" style="margin-top:10px;color:#155a8f;font-weight:700"></div>
      </div>
    </div>
  </div>

  <!-- Vault: Tus pólizas (solo archivos subidos) -->
  <div class="modal" id="vaultModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Tus pólizas</h2>
        <p style="color:#567;font-weight:600">Repositorio de archivos subidos automáticamente</p>
        <button class="close-modal" id="closeVault">×</button>
      </div>

      <div class="vault">
        <div class="vault-list" id="vaultList">
          <div class="vault-empty" id="vaultEmpty">Aún no has subido archivos.</div>
        </div>
        <div class="vault-preview" id="vaultPreview">
          <div class="vault-empty">Selecciona un archivo para previsualizar</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Condiciones / info simple reutilizable -->
  <div class="modal" id="conditionsModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="conditionsTitle">Condiciones</h2>
        <p id="conditionsSubtitle" style="color:#567;font-weight:600"></p>
        <button class="close-modal" id="closeConditionsModal">×</button>
      </div>
      <div class="conditions-text" id="conditionsBody" style="white-space:pre-wrap;background:#fff;border:1px solid rgba(52,152,219,.15);border-radius:12px;padding:14px;box-shadow:var(--depth-1)"></div>
    </div>
  </div>

  <!-- Pago / Renovación (se mantienen funcionales) -->
  <div class="modal" id="paymentModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Formas de Pago</h2>
        <p id="paymentSubtitle" style="color:#567;font-weight:600">Selecciona y completa los datos</p>
        <button class="close-modal" id="closePaymentModal">×</button>
      </div>

      <div class="pay-tabs" id="payTabs">
        <button class="pay-tab active" data-method="tarjeta"><i class="fas fa-credit-card"></i> Tarjeta</button>
        <button class="pay-tab" data-method="pse"><i class="fas fa-building-columns"></i> PSE</button>
        <button class="pay-tab" data-method="transferencia"><i class="fas fa-money-bill-transfer"></i> Transferencia</button>
        <button class="pay-tab" data-method="efectivo"><i class="fas fa-coins"></i> Efectivo</button>
      </div>

      <div id="payForms">
        <div class="pay-form" data-method="tarjeta">
          <div class="form-group"><label class="form-label">Nombre en la tarjeta</label><div class="input-wrap"><i class="fas fa-user"></i><input type="text" id="cardName" placeholder="Como aparece en la tarjeta"></div></div>
          <div class="form-group"><label class="form-label">Número de tarjeta</label><div class="input-wrap"><i class="fas fa-credit-card"></i><input type="text" id="cardNumber" placeholder="#### #### #### ####" inputmode="numeric" maxlength="19"></div></div>
          <div class="inline-2">
            <div class="form-group"><label class="form-label">Vencimiento (MM/AA)</label><div class="input-wrap"><i class="fas fa-calendar"></i><input type="text" id="cardExp" placeholder="MM/AA" maxlength="5"></div></div>
            <div class="form-group"><label class="form-label">CVV</label><div class="input-wrap"><i class="fas fa-key"></i><input type="password" id="cardCVV" placeholder="***" maxlength="4"></div></div>
          </div>
        </div>

        <div class="pay-form" data-method="pse" style="display:none">
          <div class="form-group"><label class="form-label">Banco</label>
            <div class="input-wrap"><i class="fas fa-building-columns"></i>
              <select id="pseBank"><option value="">Selecciona tu banco</option><option>Bancolombia</option><option>Davivienda</option><option>Banco de Bogotá</option><option>BBVA</option><option>Nequi</option></select>
            </div>
          </div>
          <div class="form-group"><label class="form-label">Correo del titular</label><div class="input-wrap"><i class="fas fa-envelope"></i><input type="email" id="pseEmail" placeholder="tucorreo@dominio.com"></div></div>
        </div>

        <div class="pay-form" data-method="transferencia" style="display:none">
          <div class="conditions-text" style="margin-bottom:10px">
            Transferir a:<br>
            - Banco: Bancolombia (AHORROS)<br>
            - No. Cuenta: 123-456789-01<br>
            - Titular: InsuraHub S.A.S<br>
            - NIT: 900.123.456-7
          </div>
          <div class="form-group"><label class="form-label">Adjunta comprobante (opcional)</label><div class="input-wrap"><i class="fas fa-paperclip"></i><input type="file" id="trfReceipt" accept="image/*,application/pdf"></div></div>
        </div>

        <div class="pay-form" data-method="efectivo" style="display:none">
          <div class="conditions-text">Paga en puntos aliados (Efecty/Baloto). Recibirás un código al confirmar la renovación.</div>
        </div>
      </div>

      <button class="btn" id="savePayment" style="width:100%;margin-top:10px"><i class="fas fa-floppy-disk"></i> Guardar forma de pago</button>
    </div>
  </div>

  <div class="modal" id="renewalModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Renovar Póliza</h2>
        <p>Selecciona una aseguradora y compara en tiempo real</p>
        <button class="close-modal" id="closeRenewalModal">×</button>
      </div>
      <div class="renewal-layout">
        <div class="renewal-col">
          <h3>Póliza a renovar</h3>
          <div class="detail-value" id="renewalPolicyNumber" style="margin-bottom:8px">#AUTO-123456</div>

          <h3>Selecciona una aseguradora</h3>
          <div class="renewal-options" id="renewalOptions"></div>

          <button type="button" class="btn" style="width:100%;margin-top:12px" id="confirmRenewal">
            <i class="fas fa-check-circle"></i> Confirmar Renovación
          </button>
          <div class="pay-help" id="payHint" style="display:none;margin-top:8px">
            <i class="fas fa-credit-card"></i> Forma de pago seleccionada: <strong id="payMethodLabel">—</strong>
          </div>
        </div>

        <div class="renewal-col">
          <div class="compare-title"><i class="fas fa-scale-balanced"></i> Comparación rápida</div>
          <div id="currentPolicyChip" style="margin-bottom:8px"></div>
          <div class="table-responsive">
            <table class="compare-table" id="compareTable">
              <thead>
                <tr><th>Aseguradora</th><th>Precio</th><th>Cobertura</th><th>Deducible</th><th>Extras</th><th>Detalle</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SARLAFT -->
  <div class="modal" id="sarlaftModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Formulario SARLAFT</h2>
        <p style="color:#567;font-weight:600">Completa todos los campos para quedar “al día”.</p>
        <button class="close-modal" id="closeSarlaftModal">×</button>
      </div>

      <form id="sarlaftForm">
        <div class="section-card">
          <div class="section-title"><i class="fas fa-user-shield"></i> Identificación</div>
          <div class="form-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-id-card"></i> Tipo de persona</label>
              <div class="input-wrap">
                <select name="tipoPersona" required>
                  <option value="">Selecciona</option>
                  <option>Natural</option>
                  <option>Jurídica</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-globe"></i> País de residencia</label>
              <div class="input-wrap">
                <select name="pais" required>
                  <option value="">Selecciona</option>
                  <option>Colombia</option><option>Estados Unidos</option><option>México</option>
                  <option>Chile</option><option>Perú</option><option>España</option><option>Otro</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-city"></i> Ciudad</label>
              <div class="input-wrap"><input name="ciudad" placeholder="Ej: Bogotá" required></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-briefcase"></i> Ocupación / Actividad</label>
              <div class="input-wrap">
                <select name="ocupacion" required>
                  <option value="">Selecciona</option>
                  <option>Empleado</option><option>Independiente</option><option>Empresario</option>
                  <option>Estudiante</option><option>Pensionado</option><option>Otro</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title"><i class="fas fa-sack-dollar"></i> Origen y destino de fondos</div>
          <div class="form-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-piggy-bank"></i> Origen principal de ingresos</label>
              <div class="input-wrap">
                <select name="origenIngresos" required>
                  <option value="">Selecciona</option>
                  <option>Salario</option><option>Honorarios</option><option>Rentas</option>
                  <option>Negocio propio</option><option>Inversiones</option><option>Otros</option>
                </select>
              </div>
              <div class="hint">Selecciona el origen predominante</div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-route"></i> Destino habitual de fondos</label>
              <div class="input-wrap">
                <select name="destinoFondos" required>
                  <option value="">Selecciona</option>
                  <option>Gastos personales</option><option>Pago de deudas</option>
                  <option>Ahorro/Inversión</option><option>Negocio</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-coins"></i> Ingresos mensuales (rango)</label>
              <div class="input-wrap">
                <select name="ingresos" required>
                  <option value="">Selecciona</option>
                  <option>&lt; $2.000.000</option><option>$2M – $5M</option><option>$5M – $10M</option>
                  <option>$10M – $20M</option><option>&gt; $20M</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-receipt"></i> Egresos mensuales (rango)</label>
              <div class="input-wrap">
                <select name="egresos" required>
                  <option value="">Selecciona</option>
                  <option>&lt; $1.000.000</option><option>$1M – $3M</option><option>$3M – $6M</option>
                  <option>$6M – $12M</option><option>&gt; $12M</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title"><i class="fas fa-user-lock"></i> Declaraciones y cumplimiento</div>
          <div class="form-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-scale-balanced"></i> ¿Es usted PEP (o familiar/relacionado)?</label>
              <div class="input-wrap"><select name="pep" required><option value="">Selecciona</option><option>No</option><option>Sí</option></select></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-flag-usa"></i> ¿Sujeto a FATCA/CRS (residencia fiscal exterior)?</label>
              <div class="input-wrap"><select name="fatca" required><option value="">Selecciona</option><option>No</option><option>Sí</option></select></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-bitcoin-sign"></i> ¿Opera con criptoactivos?</label>
              <div class="input-wrap"><select name="cripto" required><option value="">Selecciona</option><option>No</option><option>Sí</option></select></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-book"></i> ¿Declara renta en Colombia?</label>
              <div class="input-wrap"><select name="renta" required><option value="">Selecciona</option><option>Sí</option><option>No</option></select></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-list-check"></i> Listas restrictivas/Sanciones</label>
              <div class="input-wrap"><select name="listas" required><option value="">Selecciona</option><option>Ninguna</option><option>Observado</option><option>En revisión</option></select></div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-people-arrows"></i> ¿Tiene beneficiarios/terceros?</label>
              <div class="input-wrap"><select name="beneficiarios" required><option value="">Selecciona</option><option>No</option><option>Sí</option></select></div>
            </div>
            <div class="form-group" style="grid-column:1/-1">
              <label class="form-label"><i class="fas fa-clipboard"></i> Observaciones (opcional)</label>
              <div class="input-wrap"><textarea name="observaciones" placeholder="Comentarios adicionales..."></textarea></div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn" style="width:100%"><i class="fas fa-circle-check"></i> Guardar SARLAFT</button>
      </form>
    </div>
  </div>

  <!-- Success -->
  <div class="modal" id="successModal" aria-hidden="true" style="z-index:10000">
    <div class="modal-content" role="alert" aria-live="polite" style="max-width:520px">
      <div class="modal-header" style="margin-bottom:0">
        <h2 id="successMessage">¡Operación exitosa!</h2>
        <p id="successSub"></p>
        <button class="close-modal" id="closeSuccess">×</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Datos (demo de pólizas activas) ===== */
    const insurerLogos={allianz:"logos/allianz.png",axa:"logos/axa.png",generali:"logos/generali.png",cigna:"logos/cigna.png",zurich:"logos/zurich.png",liberty:"logos/liberty.png"};
    const insurerNames={allianz:"Allianz",axa:"AXA",generali:"Generali",cigna:"Cigna",zurich:"Zurich",liberty:"Liberty Mutual"};
    const insurerPhones={allianz:"+57 01 8000 510 510",axa:"+57 01 8000 123 456",generali:"+57 01 8000 345 678",cigna:"+57 01 8000 765 432",zurich:"+57 01 8000 111 222",liberty:"+57 01 8000 999 888"};
    const renewalPrices={allianz:850000,axa:920000,generali:780000,cigna:950000,zurich:890000,liberty:810000};
    const coverageAmounts={allianz:200000000,axa:220000000,generali:180000000,cigna:240000000,zurich:210000000,liberty:190000000};
    const offerConditions={
      allianz:{deductible:"10% o $2.000.000",extras:"Asistencia 24/7 + carro sustituto",details:"- Cobertura daños y pérdida total.\n- Deducible: 10% o $2.000.000.\n- Asistencia vial 24/7, grúa, cerrajería.\n- Carro sustituto 5 días por siniestro.\n- Exclusiones: embriaguez, uso competitivo."},
      axa:{deductible:"8% o $1.800.000",extras:"Vidrios sin deducible",details:"- Cobertura ampliada + RC.\n- Deducible: 8% o $1.800.000.\n- Reposición de vidrios sin deducible.\n- Asistencia jurídica.\n- Exclusiones: dolo, carreras."},
      generali:{deductible:"12% o $2.200.000",extras:"Revisión anual preventiva",details:"- Cobertura estándar integral.\n- Deducible: 12% o $2.200.000.\n- Revisión mecánica preventiva anual.\n- Cobertura a accesorios declarados.\n- Exclusiones: accesorios no declarados."},
      cigna:{deductible:"10% o $2.500.000",extras:"Cobertura médica ampliada",details:"- Enfoque salud/viaje.\n- Deducible: 10% o $2.500.000.\n- Gastos médicos ampliados.\n- Telemedicina.\n- Exclusiones: preexistencias según plan."},
      zurich:{deductible:"9% o $2.000.000",extras:"RC ampliada + asistencia jurídica",details:"- Cobertura integral + RC ampliada.\n- Deducible: 9% o $2.000.000.\n- Asistencia jurídica.\n- Coberturas internacionales acotadas.\n- Exclusiones: uso comercial sin declaración."},
      liberty:{deductible:"10% o $1.900.000",extras:"Pérdida de llaves + grúa",details:"- Cobertura estándar.\n- Deducible: 10% o $1.900.000.\n- Pérdida de llaves.\n- Grúa 2 eventos/año.\n- Exclusiones: desgaste normal."}
    };
    const typeIcons={auto:"car",home:"home",life:"heart",health:"heartbeat",travel:"plane",business:"briefcase"};

    /* ===== Helpers ===== */
    const qs = s => document.querySelector(s);
    const qsa= s => document.querySelectorAll(s);
    const safe = (el, fn) => { if (el) fn(el); };
    const fmtCOP=n=>new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
    const addDays=(d,n)=>{const r=new Date(d);r.setDate(r.getDate()+n);return r};
    const addYears=(d,n)=>{const r=new Date(d);r.setFullYear(r.getFullYear()+n);return r};
    const iso=d=>d.toISOString().split('T')[0];
    const human=s=>new Date(s).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
    const tel=i=>insurerPhones[i]||"N/A";
    const daysLeft=s=>{const t=new Date();t.setHours(0,0,0,0);const diff=new Date(s)-t;return Math.max(0,Math.ceil(diff/86400000))};
    const statusClass=d=>d>180?"good":d>30?"warning":"danger";
    const ringClass=d=>d>180?"status-ring-good":d>30?"status-ring-warning":"status-ring-danger";
    const ringProg=d=>Math.min(100,(d/365)*100);

    /* ===== Carga inteligente de logos ===== */
    const LOGO_EXTS=['png','svg','jpg','jpeg','webp','PNG','SVG','JPG','JPEG','WEBP'];
    function logoCandidates(key){
      const base=(key||'').toLowerCase(),cap=base.charAt(0).toUpperCase()+base.slice(1),upper=base.toUpperCase();
      const variants=[base,cap,upper,`${base}-logo`,`logo-${base}`]; const paths=[];
      variants.forEach(n=>LOGO_EXTS.forEach(ext=>paths.push(`logos/${n}.${ext}`)));
      return paths;
    }
    function loadLogoSmart(img){
      const key=(img.dataset.insurer||'').toLowerCase(); const friendly=img.dataset.friendly||key||'Logo';
      const first=(typeof insurerLogos!=='undefined'&&insurerLogos[key])?insurerLogos[key]:null;
      const list=[...new Set([first,...logoCandidates(key)].filter(Boolean))];
      let i=-1;
      const next=()=>{i++; if(i<list.length){img.onerror=next; img.src=list[i];} else {img.onerror=null; img.style.display='none'; const ph=document.createElement('div'); ph.className='logo-placeholder'; ph.textContent=friendly; img.parentNode.appendChild(ph);} };
      next();
    }

    /* ===== Datos demo pólizas activas ===== */
    const today=new Date();
    const expirationDates=[iso(addDays(today,28)),iso(addDays(today,120)),iso(addDays(today,230)),iso(addDays(today,350)),iso(addDays(today,15)),iso(addDays(today,80))];
    const policies=[
      {id:1,type:"auto",typeName:"Seguro de Auto",insurer:"allianz",insurerName:"Allianz",policyNumber:"#AUTO-789456",expirationDate:expirationDates[0],insuredId:"1234567890",insuredName:"Juan Pérez",coverage:200000000,conditions:"- Deducible: 10% del siniestro o $2.000.000, lo que sea mayor.\n- Cobertura pérdida total/daños parciales.\n- Asistencia en carretera 24/7.\n- Exclusiones: conducción en estado de embriaguez, uso competitivo."},
      {id:2,type:"home",typeName:"Seguro de Hogar",insurer:"axa",insurerName:"AXA",policyNumber:"#HOME-123789",expirationDate:expirationDates[1],insuredId:"0987654321",insuredName:"María García",coverage:350000000,conditions:"- Cobertura incendio, terremoto y robo calificado.\n- Deducible: 1% del valor asegurado por evento.\n- Límites para contenidos: $50.000.000.\n- Exclusiones: humedad por falta de mantenimiento."},
      {id:3,type:"life",typeName:"Seguro de Vida",insurer:"generali",insurerName:"Generali",policyNumber:"#LIFE-456123",expirationDate:expirationDates[2],insuredId:"4561237890",insuredName:"Carlos López",coverage:150000000,conditions:"- Fallecimiento por cualquier causa (carencia 90 días para enfermedad).\n- Anticipo por enfermedad terminal 30%.\n- Exclusiones: suicidio dentro de los primeros 2 años."},
      {id:4,type:"health",typeName:"Seguro Médico",insurer:"cigna",insurerName:"Cigna",policyNumber:"#MED-987321",expirationDate:expirationDates[3],insuredId:"7890123456",insuredName:"Ana Rodríguez",coverage:120000000,conditions:"- Red de prestadores nacional.\n- Copago por consulta general: $40.000.\n- Preexistencias cubiertas después de 12 meses.\n- Exclusiones: procedimientos estéticos."},
      {id:5,type:"travel",typeName:"Seguro de Viaje",insurer:"zurich",insurerName:"Zurich",policyNumber:"#TRAV-654987",expirationDate:expirationDates[4],insuredId:"3216549870",insuredName:"Laura Martínez",coverage:50000000,conditions:"- Asistencia médica internacional hasta $50.000.000.\n- Repatriación sanitaria y pérdida de equipaje.\n- Franquicia por evento: $100.000."},
      {id:6,type:"business",typeName:"Seguro de Negocio",insurer:"liberty",insurerName:"Liberty Mutual",policyNumber:"#BUSI-321654",expirationDate:expirationDates[5],insuredId:"6549873210",insuredName:"Pedro Sánchez",coverage:115000000,conditions:"- Responsabilidad civil comercial hasta $500.000.000.\n- Interrupción de negocio (30 días carencia).\n- Deducible: $1.500.000 por evento."}
    ];

    /* ===== Repositorio de archivos (Tus pólizas) ===== */
    const vaultDocs = []; // {id,name,type,size,blobUrl,uploadedAt}

    /* ===== DOM ===== */
    const sidebar=qs('#sidebar');
    const toggleSidebar=qs('#toggleSidebar');

    function syncSidebarByViewport(){
      if (window.matchMedia('(max-width:1100px)').matches){
        sidebar.classList.add('hidden');
      } else {
        sidebar.classList.remove('hidden');
      }
    }
    syncSidebarByViewport();
    window.addEventListener('resize', syncSidebarByViewport);
    safe(toggleSidebar, btn => btn.addEventListener('click',()=> sidebar.classList.toggle('hidden')));

    const loginBtn=qs('#loginBtn');
    const loginModal=qs('#loginModal');
    const conditionsModal=qs('#conditionsModal');
    const successModal=qs('#successModal');

    const openSARLAFTBtn=qs('#openSARLAFT');
    const sarlaftModal=qs('#sarlaftModal');
    const sarlaftBadge=qs('#sarlaftBadge');
    const sarlaftForm=qs('#sarlaftForm');

    const openUploaderBtn=qs('#openUploader');
    const uploaderModal=qs('#uploaderModal');
    const fileDrop=qs('#fileDrop');
    const fileInput=qs('#fileInput');
    const uploadHint=qs('#uploadHint');

    const openPoliciesVault=qs('#openPoliciesVault');
    const vaultModal=qs('#vaultModal');
    const vaultList=qs('#vaultList');
    const vaultEmpty=qs('#vaultEmpty');
    const vaultPreview=qs('#vaultPreview');

    const openDataUpdateBtn=qs('#openDataUpdate');

    const renewalModal=qs('#renewalModal');
    const renewalOptions=qs('#renewalOptions');
    const compareTableBody=qs('#compareTable tbody');
    const currentPolicyChip=qs('#currentPolicyChip');
    const confirmRenewalBtn=qs('#confirmRenewal');
    const paymentModal=qs('#paymentModal');
    const payTabs=qs('#payTabs');
    const payHint=qs('#payHint');
    const payMethodLabel=qs('#payMethodLabel');

    const policyGrid=qs('#policyGrid');
    const totalPoliciesEl=qs('#totalPolicies');
    const expiringPoliciesEl=qs('#expiringPolicies');
    const totalCoverageEl=qs('#totalCoverage');

    let currentRenewPolicyId=null;
    let selectedPayment={method:null};

    /* ===== Abrir/Cerrar modales ===== */
    const bindClose=(btnSel,modal)=>{ const b=qs(btnSel); if(b&&modal){ b.addEventListener('click',()=>{ modal.style.display='none'; }); } };
    bindClose('#closeLoginModal',loginModal);
    bindClose('#closeConditionsModal',conditionsModal);
    bindClose('#closePaymentModal',paymentModal);
    bindClose('#closeRenewalModal',renewalModal);
    bindClose('#closeSarlaftModal',sarlaftModal);
    bindClose('#closeUploader',uploaderModal);
    bindClose('#closeVault',vaultModal);
    bindClose('#closeSuccess',successModal);

    [loginModal,conditionsModal,paymentModal,renewalModal,sarlaftModal,uploaderModal,vaultModal,successModal]
      .forEach(m=> m && m.addEventListener('click',e=>{ if(e.target===m) m.style.display='none'; }));

    safe(loginBtn, b=> b.addEventListener('click',()=>{ loginModal.style.display='flex'; }));
    safe(qs('#loginGoogle'), el=>el.addEventListener('click',()=>alert('Continuar con Google (conectar OAuth aquí)')));
    safe(qs('#loginFacebook'),el=>el.addEventListener('click',()=>alert('Continuar con Facebook (conectar OAuth aquí)')));
    safe(qs('#loginApple'),   el=>el.addEventListener('click',()=>alert('Continuar con Apple (conectar OAuth aquí)')));

    const openConditions=(t,st,b)=>{
      const tt=qs('#conditionsTitle'), stt=qs('#conditionsSubtitle'), bd=qs('#conditionsBody');
      if(tt) tt.textContent=t||'Condiciones';
      if(stt) stt.textContent=st||'';
      if(bd) bd.textContent=b||'Sin información.';
      if(conditionsModal) conditionsModal.style.display='flex';
    };
    const toast=(t,s)=>{
      const msg=qs('#successMessage'), sub=qs('#successSub');
      if(msg) msg.textContent=t||'¡Operación exitosa!';
      if(sub) sub.textContent=s||'';
      if(successModal){ successModal.style.display='flex'; setTimeout(()=>successModal.style.display='none',1400); }
    };

    /* ===== Render tarjetas de pólizas activas ===== */
    function renderPolicies(){
      if(!policyGrid) return;
      policyGrid.innerHTML='';let exp=0,total=0;
      policies.forEach(p=>{
        const d=daysLeft(p.expirationDate); if(d<=30) exp++; total+=p.coverage;
        const card=document.createElement('div'); card.className=`card status-${statusClass(d)}`;
        card.innerHTML=`
          <div class="card-header">
            <div class="insurer-logo-header">
              <img alt="${p.insurerName}" data-insurer="${p.insurer}" data-friendly="${p.insurerName}">
            </div>
            <div class="header-right">
              <div class="insurance-type">${p.typeName}</div>
              <div class="insurance-icon"><i class="fas fa-${typeIcons[p.type]}"></i></div>
            </div>
          </div>

          <div class="card-details">
            <div class="detail-item"><span class="detail-label">Asegurado:</span><span class="detail-value">${p.insuredName}</span></div>
            <div class="detail-item"><span class="detail-label">Vencimiento:</span><span class="detail-value">${new Date(p.expirationDate).toLocaleDateString('es-ES')}</span></div>
            <div class="detail-item"><span class="detail-label">Cobertura:</span><span class="detail-value">${fmtCOP(p.coverage)}</span></div>

            <div class="contact-line"><i class="fas fa-phone"></i><span>Contacto:</span><span style="font-weight:900">${tel(p.insurer)}</span></div>

            <div class="ring-row">
              <div class="status-container">
                <div class="status-ring ${ringClass(d)}" style="--progress:${ringProg(d)}%">
                  <div class="status-ring-inner">${d}</div>
                </div>
                <div class="days-text">días restantes</div>
              </div>
              <div class="ring-actions">
                <button class="btn btn-soft conditions-btn"><i class="fas fa-file-lines"></i> Condiciones actuales</button>
                <button class="btn ${d>180?'btn-success':(d>30?'btn-warning':'btn-danger')} renew-btn" data-policy-id="${p.id}">
                  <i class="fas fa-sync-alt"></i> Renovar
                </button>
                <button class="btn btn-danger delete-btn" data-policy-id="${p.id}">
                  <i class="fas fa-trash"></i> Eliminar póliza
                </button>
              </div>
            </div>
          </div>`;
        policyGrid.appendChild(card);

        const hdrLogo=card.querySelector('.insurer-logo-header img'); if(hdrLogo){ loadLogoSmart(hdrLogo); }
        safe(card.querySelector('.conditions-btn'),btn=>btn.addEventListener('click',()=>openConditions('Condiciones de la Póliza',`${p.policyNumber} · ${p.insurerName}`,p.conditions)));
        safe(card.querySelector('.renew-btn'),btn=>btn.addEventListener('click',()=>openRenewal(p)));
        safe(card.querySelector('.delete-btn'),btn=>btn.addEventListener('click',()=>deletePolicy(p.id)));
      });
      if(totalPoliciesEl) totalPoliciesEl.textContent=policies.length;
      if(expiringPoliciesEl) expiringPoliciesEl.textContent=exp;
      if(totalCoverageEl) totalCoverageEl.textContent=fmtCOP(total);
    }

    function deletePolicy(id){
      const DELETE_CONFIRM_MSG = "Eliminando esta póliza, saldrás del ecosistema InsuraHub, no te enviaremos recordatorios de Renovación";
      if(!confirm(DELETE_CONFIRM_MSG)) return;
      const idx = policies.findIndex(p=>p.id===id);
      if(idx>-1){
        const removed = policies.splice(idx,1)[0];
        renderPolicies();
        toast('Póliza eliminada', `${removed.policyNumber} fue eliminada del ecosistema.`);
      }
    }

    /* ===== Renovación ===== */
    function highlightCheapest(){const opts=[...qsa('.insurer-option')];let m=Infinity,el=null;opts.forEach(o=>{const p=+o.dataset.price||0;if(p<m){m=p;el=o;}});opts.forEach(o=>o.classList.remove('cheapest'));if(el)el.classList.add('cheapest');}
    function highlightRow(k){if(!compareTableBody)return; compareTableBody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected-row'));const r=compareTableBody.querySelector(`tr[data-insurer="${k}"]`);if(r)r.classList.add('selected-row');}

    function renderRenewalOptions(keys){
      if(!renewalOptions) return;
      renewalOptions.innerHTML='';
      keys.forEach(k=>{
        const div=document.createElement('div');
        div.className='insurer-option'; div.tabIndex=0; div.setAttribute('role','button'); div.dataset.insurer=k; div.dataset.price=renewalPrices[k];
        div.innerHTML=`
          <div class="insurer-logo-small"><img alt="${insurerNames[k]}" data-insurer="${k}" data-friendly="${insurerNames[k]}"></div>
          <div class="insurer-details"><div>${insurerNames[k]}</div><div class="coverage-amount">Cobertura: ${fmtCOP(coverageAmounts[k])}</div></div>
          <div class="insurer-price">${fmtCOP(renewalPrices[k])}</div>`;
        renewalOptions.appendChild(div);
        const img=div.querySelector('img'); if(img){ loadLogoSmart(img); }
      });
      highlightCheapest();
    }

    function buildCompareTable(keys,policy){
      if(!compareTableBody) return;
      compareTableBody.innerHTML='';
      keys.forEach(k=>{
        const tr=document.createElement('tr'); tr.dataset.insurer=k;
        const cond=offerConditions[k]||{};
        tr.innerHTML=`
          <td><div style="display:flex;align-items:center;gap:8px">
                <img alt="${insurerNames[k]}" data-insurer="${k}" data-friendly="${insurerNames[k]}">
                <strong>${insurerNames[k]}</strong>
              </div></td>
          <td>${fmtCOP(renewalPrices[k])}</td>
          <td>${fmtCOP(coverageAmounts[k])}</td>
          <td>${cond.deductible||'-'}</td>
          <td>${cond.extras||'-'}</td>
          <td><div class="table-actions"><button class="btn" style="padding:6px 10px;border-radius:10px;font-size:12px" data-key="${k}"><i class="fas fa-eye"></i> Ver detalles</button></div></td>`;
        compareTableBody.appendChild(tr);
        const img=tr.querySelector('img'); if(img){ loadLogoSmart(img); }
      });
      const table=qs('#compareTable');
      if(table){
        table.onclick=e=>{
          const btn=e.target.closest('button[data-key]'); if(!btn) return;
          const k=btn.dataset.key;
          openConditions(`Condiciones de la oferta · ${insurerNames[k]}`,`Propuesta para ${policy.policyNumber}`,(offerConditions[k]||{}).details||'Sin detalles.');
        };
      }
    }

    function selectInsurerOption(el){
      if(!el) return;
      qsa('.insurer-option').forEach(o=>{o.classList.remove('selected');o.setAttribute('aria-selected','false');});
      el.classList.add('selected'); el.setAttribute('aria-selected','true');
      const k=el.dataset.insurer; highlightRow(k);
      const sub=qs('#paymentSubtitle'); if(sub) sub.textContent=`Método para ${insurerNames[k]}`;
      if(paymentModal) paymentModal.style.display='flex';
    }
    if(renewalOptions){
      renewalOptions.addEventListener('click',e=>{const el=e.target.closest('.insurer-option');if(!el)return;selectInsurerOption(el);});
      renewalOptions.addEventListener('keydown',e=>{const el=e.target.closest('.insurer-option');if(!el)return;if(e.key==='Enter'||e.key===' '){e.preventDefault();selectInsurerOption(el);}});
    }

    function openRenewal(p){
      currentRenewPolicyId=p.id;
      const rn=qs('#renewalPolicyNumber'); if(rn) rn.textContent=p.policyNumber;
      selectedPayment={method:null}; if(payHint) payHint.style.display='none'; if(payMethodLabel) payMethodLabel.textContent='—';
      const keys=Object.keys(insurerNames);
      renderRenewalOptions(keys);
      if(currentPolicyChip) currentPolicyChip.innerHTML=`<span class="pill">Actual: ${p.insurerName} · Cobertura ${fmtCOP(p.coverage)} · Vence ${new Date(p.expirationDate).toLocaleDateString('es-ES')} <span style="font-size:11px;font-weight:800;color:#2cb56f;margin-left:6px">vigente</span></span>`;
      buildCompareTable(keys,p);
      if(renewalModal) renewalModal.style.display='flex';
    }

    /* Pago */
    if(payTabs){
      payTabs.addEventListener('click',e=>{
        const tab=e.target.closest('.pay-tab'); if(!tab) return;
        qsa('.pay-tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active');
        const m=tab.dataset.method; qsa('.pay-form').forEach(f=>f.style.display=f.dataset.method===m?'block':'none');
      });
    }
    safe(qs('#savePayment'), btn=> btn.addEventListener('click',()=>{
      const active=qs('.pay-tab.active'); const m=active?.dataset.method; if(!m){alert('Selecciona un método de pago.');return;}
      if(m==='tarjeta'){
        const n=(qs('#cardNumber')?.value||'').replace(/\s+/g,''),nm=(qs('#cardName')?.value||'').trim(),ex=(qs('#cardExp')?.value||'').trim(),cv=(qs('#cardCVV')?.value||'').trim();
        if(!nm||n.length<12||!/^\d{2}\/\d{2}$/.test(ex)||cv.length<3){alert('Completa los datos de la tarjeta correctamente.');return;}
      }
      if(m==='pse'&&(!(qs('#pseBank')?.value)||!(qs('#pseEmail')?.value))){alert('Selecciona banco e ingresa correo.');return;}
      selectedPayment.method=m; if(payHint) payHint.style.display='block'; if(payMethodLabel) payMethodLabel.textContent=m.toUpperCase();
      if(paymentModal) paymentModal.style.display='none'; toast('Forma de pago guardada',`Método: ${m.toUpperCase()}`);
    }));

    /* ====== Sidebar: SARLAFT ====== */
    function sarlaftIsComplete(){
      if(!sarlaftForm) return false;
      const req = sarlaftForm.querySelectorAll('select[required], input[required]');
      for(const el of req){ if(!el.value || el.value.trim()==='') return false; }
      return true;
    }
    function paintSarlaftBadge(){
      const ok=sarlaftIsComplete();
      if(sarlaftBadge){
        sarlaftBadge.textContent = ok ? 'Al día' : 'Pendiente';
        sarlaftBadge.classList.toggle('ok', ok);
        sarlaftBadge.classList.toggle('bad', !ok);
      }
    }
    safe(openSARLAFTBtn, btn=> btn.addEventListener('click',()=>{ if(sarlaftModal) sarlaftModal.style.display='flex'; paintSarlaftBadge(); }));
    safe(sarlaftForm, f=> f.addEventListener('change', paintSarlaftBadge));
    safe(sarlaftForm, f=> f.addEventListener('submit', (e)=>{ e.preventDefault(); paintSarlaftBadge(); if(sarlaftIsComplete()){ toast('SARLAFT guardado', 'Tu formulario quedó AL DÍA.'); } else { alert('Faltan campos obligatorios.'); } }));

    /* ====== Uploader de archivos ====== */
    safe(openUploaderBtn, b=> b.addEventListener('click',()=>{
      if(uploaderModal) uploaderModal.style.display='flex';
      if(uploadHint) uploadHint.textContent = '';
    }));

    function openFileDialog(){ fileInput && fileInput.click(); }
    safe(fileDrop, dz=>{
      dz.addEventListener('click', openFileDialog);
      ['dragenter','dragover'].forEach(evt=> dz.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dz.style.borderColor='#2c80b9'; }));
      ['dragleave','drop'].forEach(evt=> dz.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dz.style.borderColor='rgba(52,152,219,.35)'; }));
      dz.addEventListener('drop', e=>{ const files = [...e.dataTransfer.files]; if(files?.length) handleFiles(files); });
    });
    safe(fileInput, inp=> inp.addEventListener('change', e=>{ const files=[...e.target.files]; if(files?.length) handleFiles(files); }));

    function handleFiles(files){
      let added=0;
      files.forEach(f=>{
        const id = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
        const blobUrl = URL.createObjectURL(f);
        vaultDocs.push({id,name:f.name,type:f.type,size:f.size,blobUrl,uploadedAt:new Date()});
        added++;
      });
      if(uploadHint) uploadHint.textContent = `Cargados: ${added}`;
      toast('Archivos subidos', `Se agregaron ${added} archivo(s) a “Tus pólizas”.`);
      if(uploaderModal) uploaderModal.style.display='none';
    }

    /* ====== Vault (Tus pólizas) ====== */
    safe(openPoliciesVault, b=> b.addEventListener('click',()=>{
      renderVaultList();
      if(vaultModal) vaultModal.style.display='flex';
    }));

    function renderVaultList(){
      if(!vaultList) return;
      vaultList.innerHTML = '';
      if(vaultDocs.length===0){
        if(vaultEmpty){ vaultEmpty.style.display='block'; vaultList.appendChild(vaultEmpty); }
        vaultPreview.innerHTML = '<div class="vault-empty">Selecciona un archivo para previsualizar</div>';
        return;
      }
      if(vaultEmpty) vaultEmpty.style.display='none';
      vaultDocs
        .sort((a,b)=> b.uploadedAt - a.uploadedAt)
        .forEach(doc=>{
          const item = document.createElement('div');
          item.className='vault-item';
          item.dataset.id = doc.id;
          item.innerHTML = `
            <div class="file-icon"><i class="${iconFor(doc.type)}"></i></div>
            <div class="meta">
              <div class="name">${escapeHtml(doc.name)}</div>
              <div class="sub">${(doc.type||'archivo')} · ${(doc.size/1024).toFixed(0)} KB · ${doc.uploadedAt.toLocaleDateString('es-ES')}</div>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn" style="padding:6px 10px;border-radius:10px;font-size:12px" data-action="preview"><i class="fas fa-eye"></i></button>
              <a class="btn" style="padding:6px 10px;border-radius:10px;font-size:12px" href="${doc.blobUrl}" download="${encodeURIComponent(doc.name)}"><i class="fas fa-download"></i></a>
              <button class="btn btn-danger" style="padding:6px 10px;border-radius:10px;font-size:12px" data-action="delete"><i class="fas fa-trash"></i></button>
            </div>
          `;
          vaultList.appendChild(item);
        });

      vaultList.onclick = (e)=>{
        const row = e.target.closest('.vault-item'); if(!row) return;
        const id = row.dataset.id;
        const doc = vaultDocs.find(x=>x.id===id);
        const actionBtn = e.target.closest('[data-action]');
        if(actionBtn){
          const act = actionBtn.dataset.action;
          if(act==='preview'){ previewDoc(doc); }
          if(act==='delete'){ deleteDoc(doc?.id); }
          return;
        }
        previewDoc(doc);
      };
      // Seleccionar primero por UX
      previewDoc(vaultDocs[0]);
    }

    function deleteDoc(id){
      if(!confirm('¿Eliminar este archivo del repositorio?')) return;
      const idx = vaultDocs.findIndex(x=>x.id===id);
      if(idx>-1){
        try{ URL.revokeObjectURL(vaultDocs[idx].blobUrl); }catch{}
        vaultDocs.splice(idx,1);
        renderVaultList();
        toast('Archivo eliminado', 'Se quitó del repositorio.');
      }
    }

    function iconFor(type){
      if(!type) return 'fas fa-file';
      if(type.includes('pdf')) return 'fas fa-file-pdf';
      if(type.includes('image')) return 'fas fa-file-image';
      if(type.includes('word') || type.includes('document')) return 'fas fa-file-word';
      if(type.includes('excel') || type.includes('sheet')) return 'fas fa-file-excel';
      return 'fas fa-file';
    }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    function previewDoc(doc){
      if(!doc || !vaultPreview) return;
      const t = (doc.type||'').toLowerCase();
      if(t.includes('pdf')){
        vaultPreview.innerHTML = `<iframe src="${doc.blobUrl}" style="width:100%;height:60vh;border:0"></iframe>`;
      } else if(t.includes('image')){
        vaultPreview.innerHTML = `<img src="${doc.blobUrl}" alt="${escapeHtml(doc.name)}" style="max-width:100%;max-height:60vh;object-fit:contain">`;
      } else {
        vaultPreview.innerHTML = `
          <div class="vault-empty" style="display:flex;flex-direction:column;gap:10px;align-items:center">
            <i class="${iconFor(t)}" style="font-size:32px"></i>
            <div>No se puede previsualizar este tipo. Puedes descargarlo.</div>
            <a class="btn" href="${doc.blobUrl}" download="${encodeURIComponent(doc.name)}"><i class="fas fa-download"></i> Descargar</a>
          </div>`;
      }
    }

    /* ====== “Actualización de datos” resumen ====== */
    safe(openDataUpdateBtn, b=> b.addEventListener('click',()=>{
      const title = qs('#conditionsTitle'); const sub = qs('#conditionsSubtitle'); const body = qs('#conditionsBody');
      if(title) title.textContent = 'Actualización de datos';
      if(sub) sub.textContent = 'Info de inicio de sesión, SARLAFT y pólizas (activas + archivos)';
      const sarlaftOk = sarlaftIsComplete();
      const totalActivas = policies.length;
      const vencen30 = policies.filter(p=> daysLeft(p.expirationDate) <= 30).length;
      const totalArchivos = vaultDocs.length;
      const texto = `• Inicio de sesión: (simulado)
• SARLAFT: ${sarlaftOk?'Completo ✅':'Pendiente ❗'}
• Pólizas activas: ${totalActivas}
• Por vencer (30 días): ${vencen30}
• Archivos en “Tus pólizas”: ${totalArchivos}

Si necesitas corregir algo, actualiza SARLAFT o sube/gestiona tus archivos.`;
      if(body) body.textContent = texto;
      if(conditionsModal) conditionsModal.style.display='flex';
    }));

    /* ===== Init ===== */
    renderPolicies();

    /* ===== Manifest + Service Worker (seguro) ===== */
    (function(){
      const manifest={name:"InsuraHub",short_name:"InsuraHub",start_url:".",scope:".",display:"standalone",background_color:"#ffffff",theme_color:"#3498db",icons:[{src:"icons/icon-192.png",sizes:"192x192",type:"image/png"},{src:"icons/icon-512.png",sizes:"512x512",type:"image/png"}]};
      const blob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
      const url=URL.createObjectURL(blob); const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
    })();
    (function(){
      if(!('serviceWorker' in navigator))return;
      const isLocal=['localhost','127.0.0.1','[::1]'].includes(location.hostname);
      const isSecure=location.protocol==='https:'||isLocal;
      if(!isSecure){console.warn('SW deshabilitado: usa https o localhost.');return;}
      const sw=`const C='insurahub-app-v1';
self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll([self.location.href])).then(()=>self.skipWaiting()))});
self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k===C?null:caches.delete(k)))));self.clients.claim()});
self.addEventListener('fetch',e=>{const r=e.request;e.respondWith(caches.match(r).then(x=>x||fetch(r).then(res=>{if(r.method==='GET'&&res.status===200){try{const u=new URL(r.url);if(u.origin===location.origin){const cp=res.clone();caches.open(C).then(c=>c.put(r,cp))}}catch{}}return res}).catch(()=>caches.match(self.location.href))))})`;
      const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url);
    })();
  </script>
</body>
</html>
